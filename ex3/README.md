# EX 3 - Understand the RunTableModel and `RunnerConfig.py`
## Overview

**The RunTableModel** defines an experiment's measurements with *Factors*, their *Treatment* levels, *exclude certain combinations* of Treatments, number of *repetitions* and add *data columns* for storing aggregated data.

**RunnerConfig.py** is the entrance that passes user-defined configuration to Experiment Runner Controller. Experiment Runner will:
- Validate the config
- Output the config's values as read by Experiment Runner in the console for user validation
- Create the experiment folder
- Create the run table (.csv), and persist it in the experiment folder
- Execute the experiment on a per-variation basis, going over each variation with its specified treatments in the run table.


Then following examples use part code of `experiment-runner/examples/hello-world-fibonacci
/RunnerConfig.py`.
## Example 1 

```python
def create_run_table_model(self) -> RunTableModel:
    """Create and return the run_table model here. A run_table is a List (rows) of tuples (columns),
    representing each run performed"""
    factor1 = FactorModel("fib_type", ['iter', 'mem', 'rec'])
    factor2 = FactorModel("problem_size", [10, 35, 40, 5000, 10000])
    self.run_table_model = RunTableModel(
        factors=[factor1, factor2],
        exclude_combinations=[
            {factor2: [10]},   # all runs having treatment "10" will be excluded
            {factor1: ['rec'], factor2: [5000, 10000]},
            {factor1: ['mem', 'iter'], factor2: [35, 40]},  # all runs having the combination ("iter", 30) will be excluded
        ],
        repetitions = 10,
        data_columns=["energy", "runtime", "memory"]
    )
    return self.run_table_model

```
It is expected to repeat 10 times, generate 60 experiment results in total, and produce `run_table.csv` in the following format (this example was produced on Mac, energy in Watts):

|__run_id | __done | fib_type | problem_size | energy | runtime | memory|
| ------------- | ------------- |-------------| ------------- | ------------- |-------------|-------------|
|run_0_repetition_0 | DONE | rec | 40 | 61.3 | 21.9402 | 10778673152|

Check `experiment-runner/examples/hello-world-fibonacci/experiments/new_runner_experiment/` and explore more details.


## Example 2 

```python
def start_measurement(self, context: RunnerContext) -> None:
    """Perform any activity required for starting measurements."""
    fib_type = context.execute_run["fib_type"]
    problem_size = context.execute_run["problem_size"]
    
    self.profiler = EnergiBridge(target_program=f"python examples/hello-world-fibonacci/fibonacci_{fib_type}.py {problem_size}",
                                 out_file=context.run_dir / "energibridge.csv")

    self.profiler.start()
```

```python

def populate_run_data(self, context: RunnerContext) -> Optional[Dict[str, Any]]:
    """Parse and process any measurement data here.
    You can also store the raw measurement data under `context.run_dir`
    Returns a dictionary with keys `self.run_table_model.data_columns` and their values populated"""
    
    eb_log, eb_summary = self.profiler.parse_log(self.profiler.logfile, 
                                                 self.profiler.summary_logfile)
    
    return {"energy": list(eb_log["PACKAGE_ENERGY (J)"].values())[-1] - list(eb_log["PACKAGE_ENERGY (J)"].values())[0],  # Linux Output
            "runtime": eb_summary["runtime_seconds"], 
            "memory": max(eb_log["USED_MEMORY"].values())}
```

`run_table.csv` shows the final results, generated by combining all `energibridge.csv` files from 10 repetitions. The computation follows the method in `populate_run_date()`. You can check the code for more details.

## Exploration
Play around with more parameters and see what happens.

### Using Hooks in Experiment-Runner
Hooks in `experiment-runner` are specific methods within the `RunnerConfig` class. They allow you to execute actions at various points during the lifecycle of an experiment. These hooks can be used to prepare data, initiate measurements, handle results, etc.

### Hooks Descriptions
 - `before_experiment()`: called once before the entire experiment starts. It is generally used to perform any initial setup required for the experiment
 - `before_run()`: invoked before each individual run within an experiment
 - `start_run()`: called at the very start of each run
 - `start_measurement()`: triggered when the measurement phase of each run starts
 - `interact()`: used to interact with the running target system
 - `stop_measurement()`: called to stop any ongoing measurements 
 - `stop_run()` : called after a run completes
 - `populate_run_data()`: used to process and populate the run data once a run is completed
 - `after_experiment()`: called once after the entire experiment ends. It can be used to perform any cleanup or finalization required at the end of all runs

## Troubleshooting
- `FileExistsError` error
```
FileExistsError: [Errno 17] File exists..
```
This may be because a directory with the default name `new_runner_experiment` already exists. You can either delete it if itâ€™s no longer needed, or change the parameter at `RunnerConfig.py`.


